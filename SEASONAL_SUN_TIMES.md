# 四季日出日落時間自動調整系統

## 📋 功能概述

燒天預測系統現已實現**四季日出日落時間自動調整**功能，使用天文計算庫精確計算香港地區每日的日出日落時間，並根據季節自動調整燒天預測的最佳拍攝時段。

## ⚙️ 技術實現

### 核心函數

#### `get_seasonal_sun_times(date=None)`
主要的日出日落計算函數，支持兩種計算方式：

1. **精確天文計算** (首選)
   - 使用 `astral` 庫進行天文計算
   - 基於香港經緯度 (22.3193°N, 114.1694°E)
   - 自動處理時區轉換 (Asia/Hong_Kong)
   - 精確度：分鐘級

2. **月度時間表備用方案**
   - 當 astral 庫不可用時使用
   - 基於香港天文台觀測數據
   - 按月份提供近似值
   - 精確度：5-10分鐘誤差

### 返回數據結構

```python
{
    'sunset': '18:04',           # 日落時間字串
    'sunrise': '07:04',          # 日出時間字串
    'sunset_dt': datetime(...),  # 日落 datetime 對象
    'sunrise_dt': datetime(...), # 日出 datetime 對象
    'method': 'astral'           # 計算方式
}
```

### 衍生函數

- `get_optimal_sunset_time()` - 獲取日落時間（向後兼容）
- `get_optimal_sunrise_time()` - 獲取日出時間
- `get_optimal_burnsky_time()` - 獲取最佳日落燒天時間（日落前40分鐘）
- `get_optimal_sunrise_burnsky_time()` - 獲取最佳日出燒天時間（日出後10分鐘）

## 🌐 API 端點

### `/api/sun-times`

返回今日和明日的完整日出日落信息，包括：

**請求示例:**
```bash
curl http://localhost:5001/api/sun-times
```

**回應示例:**
```json
{
  "status": "success",
  "calculation_method": "astral",
  "calculation_note": "使用天文計算精確時間",
  "today": {
    "date": "2026-01-21",
    "day_of_week": "星期三",
    "sunrise": "07:04",
    "sunset": "18:04",
    "golden_hour": "17:34",
    "sunrise_golden": "07:14",
    "burnsky_optimal": "17:24",
    "daylight_duration": "10小時59分鐘"
  },
  "tomorrow": {
    "date": "2026-01-22",
    "day_of_week": "星期四",
    "sunrise": "07:04",
    "sunset": "18:04",
    "golden_hour": "17:34",
    "sunrise_golden": "07:14",
    "burnsky_optimal": "17:24"
  },
  "season": {
    "name": "冬季",
    "emoji": "❄️",
    "note": "冬季日照時間短，日落較早，燒天機率較高",
    "month": 1
  },
  "photography_guide": {
    "sunset_burnsky": {
      "start_time": "17:24",
      "peak_time": "17:34",
      "end_time": "18:04",
      "duration": "約70分鐘黃金拍攝時段"
    },
    "sunrise_burnsky": {
      "start_time": "07:04",
      "peak_time": "07:14",
      "end_time": "07:34",
      "duration": "約30分鐘黃金拍攝時段"
    }
  },
  "location": "Hong Kong (22.3193°N, 114.1694°E)",
  "timezone": "Asia/Hong_Kong (UTC+8)"
}
```

## 📊 四季時間變化

基於 2026 年測試數據：

| 季節 | 日出時間 | 日落時間 | 日照時長 | 最佳燒天時間 |
|------|---------|---------|---------|------------|
| ❄️ 冬季 (1月) | 07:05 | 17:59 | 10小時54分 | 17:19 |
| 🌸 春季 (4月) | 06:03 | 18:43 | 12小時40分 | 18:03 |
| ☀️ 夏季 (7月) | 05:48 | 19:10 | 13小時21分 | 18:30 |
| 🍂 秋季 (10月) | 06:20 | 17:58 | 11小時38分 | 17:18 |

### 季節特性

- **冬季** (12-2月): 日照短，日落早，燒天機率最高
- **春季** (3-5月): 天氣多變，雲層豐富，適合拍攝
- **夏季** (6-8月): 日照長，日落晚，午後雷雨需注意
- **秋季** (9-11月): 天氣穩定，能見度佳，黃金季節

## 🎯 實際應用

### 1. 燒天預測整合
系統自動使用當日精確的日出日落時間來：
- 判斷當前是否處於燒天時段
- 計算最佳拍攝時間
- 調整時間因子評分權重

### 2. 提前預測
支持預測未來 24 小時內的日出日落時間，用於：
- 提前規劃拍攝行程
- 預測明日燒天機率
- 多日行程安排

### 3. 拍攝指南
自動生成個性化拍攝建議：
- 日落燒天：日落前40分鐘開始，持續70分鐘
- 日出燒天：日出後10分鐘開始，持續30分鐘
- 黃金時段：日落前30分鐘（光線最柔和）

## 🔧 測試驗證

執行測試腳本：
```bash
python test_seasons.py
```

測試內容：
- 四季代表月份的日出日落時間
- 天文計算精確度
- 日照時長計算
- 季節判斷邏輯

## 📈 性能優化

- API 回應快取：30分鐘
- 天文計算快取：避免重複計算
- 備用方案：確保系統穩定性
- 錯誤處理：優雅降級到月度時間表

## 🚀 未來改進

1. **更精細的時間粒度**
   - 支持按日計算（目前為月度平均）
   - 考慮地形遮擋影響

2. **多地點支持**
   - 支持香港不同區域的日出日落時間差異
   - 添加常見拍攝地點的精確時間

3. **歷史數據分析**
   - 統計不同季節的燒天成功率
   - 優化最佳拍攝時段建議

4. **前端可視化**
   - 添加日照時間圖表
   - 顯示四季變化趨勢
   - 實時太陽位置追蹤

## 📝 更新日誌

### v1.0 (2026-01-21)
- ✅ 實現四季自動調整核心功能
- ✅ 整合 astral 天文計算庫
- ✅ 添加 `/api/sun-times` API 端點
- ✅ 創建季節性拍攝指南
- ✅ 完整測試驗證四季時間變化

## 🛠️ 依賴項

- `astral>=2.2` - 天文計算庫
- `pytz` - 時區處理
- `python-dateutil` - 日期處理

## 📞 技術支援

如有問題或建議，請參考：
- API 文檔：`/api` 端點
- 測試腳本：`test_seasons.py`
- 主程式碼：`app.py` (line 711-810)
