<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>燒天預測測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #loading { display: block; color: blue; }
        #content { display: none; }
        button { padding: 10px 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>燒天預測系統測試</h1>
    
    <div id="loading">載入中...</div>
    
    <div id="content">
        <h2>預測結果</h2>
        <p>燒天指數: <span id="scoreNumber">-</span></p>
        <p>預測等級: <span id="predictionLevel">-</span></p>
        <p>機率: <span id="probability">-</span></p>
        
        <button onclick="loadPrediction()">🔄 重新預測</button>
        <button onclick="testAPI()">🧪 測試API</button>
    </div>

    <div id="debug"></div>

    <script>
        async function testAPI() {
            const debug = document.getElementById('debug');
            debug.innerHTML = '測試API中...';
            
            try {
                const response = await fetch('/predict/sunset?advance_hours=2');
                const data = await response.json();
                debug.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                debug.innerHTML = `錯誤: ${error.message}`;
            }
        }

        async function loadPrediction() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const debug = document.getElementById('debug');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            debug.innerHTML = '開始載入預測...';
            
            try {
                const apiUrl = `/predict/sunset?advance_hours=2&_=${Date.now()}`;
                debug.innerHTML += `<br>API URL: ${apiUrl}`;
                
                const response = await fetch(apiUrl, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                debug.innerHTML += `<br>Response status: ${response.status}`;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                debug.innerHTML += `<br>Data received: ${JSON.stringify(data).substring(0, 100)}...`;
                
                // 更新燒天指數
                document.getElementById('scoreNumber').textContent = Math.round(data.burnsky_score || data.score || 0);
                
                // 更新預測等級
                document.getElementById('predictionLevel').textContent = data.prediction_level || data.level || '未知';
                
                // 更新機率
                document.getElementById('probability').textContent = data.probability || '未知';
                
                loading.style.display = 'none';
                content.style.display = 'block';
                debug.innerHTML += '<br>✅ 載入成功！';
                
            } catch (error) {
                debug.innerHTML += `<br>❌ 錯誤: ${error.message}`;
                loading.innerHTML = `
                    <div style="color: #ff6b6b;">
                        <h3>載入失敗</h3>
                        <p>無法取得預測數據，請檢查網路連接或稍後再試</p>
                        <button onclick="loadPrediction()" style="margin-top: 15px;">🔄 重新載入</button>
                    </div>
                `;
            }
        }

        // 頁面載入時自動執行
        document.addEventListener('DOMContentLoaded', function() {
            loadPrediction();
        });
    </script>
</body>
</html>
